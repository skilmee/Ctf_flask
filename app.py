from flask import Flask, render_template, request, redirect, url_for, session, flash
import random

app = Flask(__name__)
app.secret_key = "change-this-secret-key"

# =========================================================
# –ò–≥—Ä–∞ 1: –ù–∞—Ä—è–¥–∏—Ç—å —ë–ª–∫—É –∑–∞ –æ—Ç–≤–µ—Ç—ã (—Ä–µ–∂–∏–º quiz)
# =========================================================

QUIZ_TASKS = [
    {
        "explain": (
            "–ö—Ä–∏–ø—Ç–æ‚Äë–∫–æ—Ç –ú–æ—Ä–æ–∑ —Ö–æ—á–µ—Ç –≤–∫–ª—é—á–∏—Ç—å —É–º–Ω—É—é –≥–∏—Ä–ª—è–Ω–¥—É –Ω–∞ —ë–ª–∫–µ. "
            "–û–Ω–∞ –ø–æ–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ —à–∏—Ñ—Ä –¶–µ–∑–∞—Ä—è: –∫–∞–∂–¥—É—é –±—É–∫–≤—É —Å–¥–≤–∏–≥–∞—é—Ç –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–π –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É. "
            "–ß–∏—Å–ª–æ —à–∞–≥–æ–≤ ‚Äî —ç—Ç–æ –∫–ª—é—á."
        ),
        "vraag": (
            "–ì–∏—Ä–ª—è–Ω–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ª–æ–≤–æ ¬´–º–Ω–∞—ç¬ª, –∞ –∫–æ—Ç –ø–æ–º–Ω–∏—Ç, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å–¥–≤–∏–≥ ‚àí2.\n"
            "–ö–∞–∫–æ–µ —Å–ª–æ–≤–æ —Å–∫—Ä—ã—Ç–æ –≤–Ω—É—Ç—Ä–∏?"
        ),
        "options": ["—à–∏—Ñ—Ä", "–∫–ª—é—á", "—Å–µ–π—Ñ", "–±–ª–æ–∫"],
        "answer": "–∫–ª—é—á",
        "why": "–ï—Å–ª–∏ –∫–∞–∂–¥—É—é –±—É–∫–≤—É ¬´–º–Ω–∞—ç¬ª —Å–¥–≤–∏–Ω—É—Ç—å –Ω–∞ –¥–≤–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞–∑–∞–¥, –ø–æ–ª—É—á–∏—Ç—Å—è —Å–ª–æ–≤–æ ¬´–∫–ª—é—á¬ª.",
    },
    {
        "explain": (
            "–¢–µ–ø–µ—Ä—å –∫–æ—Ç —à–∏—Ñ—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤ —Å–¥–≤–∏–≥–æ–º +1: –∫–∞–∂–¥—É—é –±—É–∫–≤—É –æ–Ω —Å–¥–≤–∏–≥–∞–µ—Ç "
            "–Ω–∞ –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é –≤–ø–µ—Ä—ë–¥ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É. –¢–∞–∫–æ–π —Ç—Ä—é–∫ —Ç–æ–∂–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —à–∏—Ñ—Ä–æ–º –¶–µ–∑–∞—Ä—è."
        ),
        "vraag": (
            "–û–Ω –≤–∑—è–ª —Å–ª–æ–≤–æ ¬´—Ö—ç—à¬ª –∏ –ø—Ä–∏–º–µ–Ω–∏–ª —Å–¥–≤–∏–≥ +1.\n"
            "–ö–∞–∫–æ–π –Ω–∞–±–æ—Ä –±—É–∫–≤ –ø–æ–ª—É—á–∏—Ç—Å—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ?"
        ),
        "options": ["—Ü—ç–∏", "—à—ç—Ü", "—Ä—É–∏", "—Ç—ç–≥"],
        "answer": "—Ü—ç–∏",
        "why": "–ü—Ä–∏ —Å–¥–≤–∏–≥–µ +1 –∫–∞–∂–¥–∞—è –±—É–∫–≤–∞ ¬´—Ö—ç—à¬ª —É–µ–∑–∂–∞–µ—Ç –≤–ø–µ—Ä—ë–¥ –Ω–∞ –æ–¥–∏–Ω —à–∞–≥, –æ–±—Ä–∞–∑—É—è ¬´—Ü—ç–∏¬ª.",
    },
    {
        "explain": (
            "–ß—Ç–æ–±—ã —Å–ø—Ä—è—Ç–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤, –∫–æ—Ç –ú–æ—Ä–æ–∑ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –µ–≥–æ –≤ –≤–∏–¥–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–º–∫–æ–≤. "
            "–ù–æ –±–µ–∑ –æ–¥–Ω–æ–≥–æ –≤–∞–∂–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ —ç—Ç–∏ –∑–∞–º–∫–∏ –Ω–µ –æ—Ç–∫—Ä—ã—Ç—å."
        ),
        "vraag": (
            "–ß—Ç–æ –Ω—É–∂–Ω–æ –∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –¥–≤–µ—Ä–Ω–æ–≥–æ –∑–∞–º–∫–∞, –∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º?"
        ),
        "options": ["–∑–∞–º–æ–∫", "—à–∏—Ñ—Ä", "–∫–ª—é—á", "—Ö—ç—à"],
        "answer": "–∫–ª—é—á",
        "why": "–ò –∑–∞–º–æ–∫, –∏ —à–∏—Ñ—Ä –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –∫–ª—é—á–∞ ‚Äî —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –∏–ª–∏ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ.",
    },
    {
        "explain": (
            "–ö–æ—Ç –ú–æ—Ä–æ–∑ —Ä–µ—à–∞–µ—Ç, –∫–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥–æ—Å—Ç–µ–π –Ω–∞ –Ω–æ–≤–æ–≥–æ–¥–Ω—é—é –≤–µ—á–µ—Ä–∏–Ω–∫—É. "
            "–û–Ω —Ö–æ—á–µ—Ç, —á—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–º–µ–Ω–∞."
        ),
        "vraag": (
            "–ö–∞–∫ –ª—É—á—à–µ –≤—Å–µ–≥–æ –Ω–∞–∑–≤–∞—Ç—å —Å–ø–æ—Å–æ–± –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Ç–∞–∫, "
            "—á—Ç–æ–±—ã –æ–Ω —Å—Ç–∞–ª –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–º –±–µ–∑ –∫–ª—é—á–∞?"
        ),
        "options": ["–±—É–∫–≤–∞", "–ø–∞—Ä–æ–ª—å", "—Ç–∞–±–ª–∏—Ü–∞", "—à–∏—Ñ—Ä"],
        "answer": "—à–∏—Ñ—Ä",
        "why": "–®–∏—Ñ—Ä ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —á—Ç–æ–±—ã –µ—ë –Ω–µ–ª—å–∑—è –±—ã–ª–æ –ø–æ–Ω—è—Ç—å –±–µ–∑ –∫–ª—é—á–∞.",
    },
    {
        "explain": (
            "–î–ª—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –ø—Ä–∏–∑–æ–≤ –∫–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É, –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç —Ö—ç—à–∏ –Ω–æ–≤–æ–≥–æ–¥–Ω–∏—Ö –±–∏–ª–µ—Ç–æ–≤. "
            "–ü–æ –≤–∏–¥—É —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —è—á–µ–π–∫–∏, –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏."
        ),
        "vraag": "–ß—Ç–æ –∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —á–∞—â–µ –≤—Å–µ–≥–æ —Ö—Ä–∞–Ω–∏—Ç —Ç–∞–∫–∏–µ —Ö—ç—à–∏?",
        "options": ["–∫–æ–º–ø—å—é—Ç–µ—Ä", "—Ç–∞–±–ª–∏—Ü–∞", "–∞–ª–≥–æ—Ä–∏—Ç–º", "—Ä–µ–≥–∏—Å—Ç—Ä"],
        "answer": "—Ç–∞–±–ª–∏—Ü–∞",
        "why": "–¢–∞–±–ª–∏—Ü–∞ ‚Äî —É–¥–æ–±–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ö—ç—à–µ–π –≤ –ø–∞–º—è—Ç–∏ –∏–ª–∏ –±–∞–∑–µ.",
    },
    {
        "explain": (
            "–ß—Ç–æ–±—ã —Å–ø—Ä—è—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è, –∫–æ—Ç –ú–æ—Ä–æ–∑ –Ω–µ –∫–ª–∞–¥—ë—Ç –µ–≥–æ –≤ –∫–æ–Ω–≤–µ—Ä—Ç, "
            "–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–∏—Ñ—Ä–æ–≤—É—é –º–∞–≥–∏—é."
        ),
        "vraag": "–ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –µ–º—É —Å–∫—Ä—ã—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–∏—Å—å–º–∞, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—è –±—É–º–∞–≥—É?",
        "options": ["–∑–∞–º–æ–∫", "–ø–∞—Ä–æ–ª—å", "—à–∏—Ñ—Ä", "–∫–æ–Ω–≤–µ—Ä—Ç"],
        "answer": "—à–∏—Ñ—Ä",
        "why": "–®–∏—Ñ—Ä –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–π –Ω–∞–±–æ—Ä —Å–∏–º–≤–æ–ª–æ–≤ –∏ —Å–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ.",
    },
    {
        "explain": (
            "–î–µ–¥ –ú–æ—Ä–æ–∑ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∫–∏ –æ—Å–æ–±–æ–π –∫—Ä–∏–ø—Ç–æ‚Äë–ø–æ–¥–ø–∏—Å—å—é, "
            "—á—Ç–æ–±—ã –≤—Å–µ –∑–Ω–∞–ª–∏, —á—Ç–æ –ø–∏—Å—å–º–æ –Ω–µ –ø–æ–¥–¥–µ–ª–∫–∞."
        ),
        "vraag": (
            "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å –ø–∏—Å—å–º–∞, "
            "—Ö–æ—Ç—è —ç—Ç–æ –Ω–µ –ø–∞—Å–ø–æ—Ä—Ç?"
        ),
        "options": ["–ø–æ–¥–ø–∏—Å—å", "–±–ª–æ–∫—á–µ–π–Ω", "–∫–ª—é—á", "–±—É–º–∞–≥–∞"],
        "answer": "–ø–æ–¥–ø–∏—Å—å",
        "why": "–¶–∏—Ñ—Ä–æ–≤–∞—è –ø–æ–¥–ø–∏—Å—å —Å–ª—É–∂–∏—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ —Å–æ–æ–±—â–µ–Ω–∏—è.",
    },
    {
        "explain": (
            "–ö–æ—Ç –ú–æ—Ä–æ–∑ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–∏—Ä–ª—è–Ω–¥—ã –≤ –≤–∏–¥–µ –¥–ª–∏–Ω–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –Ω—É–ª–µ–π –∏ –µ–¥–∏–Ω–∏—Ü. "
            "–¢–∞–∫—É—é –∑–∞–ø–∏—Å—å —É–¥–æ–±–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∏ –±—ã—Å—Ç—Ä–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å."
        ),
        "vraag": "–ß—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ –æ–±—ã—á–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç –≤ –≤–∏–¥–µ –Ω—É–ª–µ–π –∏ –µ–¥–∏–Ω–∏—Ü?",
        "options": ["–∞–ª–≥–æ—Ä–∏—Ç–º", "—à–∏—Ñ—Ä", "—Ö—ç—à", "—Ç–∞–±–ª–∏—Ü–∞"],
        "answer": "—Ö—ç—à",
        "why": "–•—ç—à ‚Äî —ç—Ç–æ –±–∏–Ω–∞—Ä–Ω–æ–µ (—Ü–∏—Ñ—Ä–æ–≤–æ–µ) –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –Ω–∞–±–æ—Ä –Ω—É–ª–µ–π –∏ –µ–¥–∏–Ω–∏—Ü.",
    },
    {
        "explain": (
            "–ë–µ–∑ –æ–¥–Ω–æ–≥–æ –≤–∞–∂–Ω–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞ –∫–æ—Ç –ü—Ä–µ–∑–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ. "
            "–≠—Ç–æ—Ç —Å–µ–∫—Ä–µ—Ç –Ω—É–∂–µ–Ω –∫–∞–∂–¥–æ–º—É –∞–ª–≥–æ—Ä–∏—Ç–º—É —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è."
        ),
        "vraag": "–ß—Ç–æ —ç—Ç–æ –∑–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç?",
        "options": ["–ø–∏—Å—å–º–æ", "–∫–æ–¥", "—Å–µ–π—Ñ", "–∫–ª—é—á"],
        "answer": "–∫–ª—é—á",
        "why": "–í–æ –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å—Ö–µ–º–∞—Ö —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω –∫–ª—é—á ‚Äî –±–µ–∑ –Ω–µ–≥–æ —à–∏—Ñ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.",
    },
    {
        "explain": (
            "–ö—Ä–∏–ø—Ç–æ‚Äë–∫–æ—Ç –ø—Ä–∏–¥—É–º—ã–≤–∞–µ—Ç —Ñ—Ä–∞–∑—É, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è —Ç–∞–π–Ω–æ–π, "
            "–Ω–æ –ø—Ä–∏ —ç—Ç–æ–º —Å–ª—É–∂–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫–æ–º –∫ –ø–æ–¥–∞—Ä–∫–∞–º."
        ),
        "vraag": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–∞–∫–æ–π —Å–µ–∫—Ä–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å –∏ –≤–≤–æ–¥–∏—Ç—å –ø—Ä–∏ –≤—Ö–æ–¥–µ?",
        "options": ["–∞–ª–≥–æ—Ä–∏—Ç–º", "–ø–∞—Ä–æ–ª—å", "–±—É–º–∞–≥–∞", "–±–ª–æ–∫–Ω–æ—Ç"],
        "answer": "–ø–∞—Ä–æ–ª—å",
        "why": "–ü–∞—Ä–æ–ª—å ‚Äî —ç—Ç–æ —Å–µ–∫—Ä–µ—Ç–Ω–∞—è —Ñ—Ä–∞–∑–∞ –∏–ª–∏ –Ω–∞–±–æ—Ä —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ –∏–ª–∏ –ø–æ–¥–∞—Ä–∫–∞–º.",
    },
    {
        "explain": (
            "–ß—Ç–æ–±—ã –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞ –°–µ–≤–µ—Ä–Ω–æ–º –ø–æ–ª—é—Å–µ –æ–±–º–µ–Ω–∏–≤–∞–ª–∏—Å—å –ø–∏—Å—å–º–∞–º–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ, "
            "—ç–ª—å—Ñ—ã –ø—Ä–∏–¥—É–º–∞–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ ‚Äî –∫—Ç–æ –∏ –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ, –∫–∞–∫ –∏—Ö —à–∏—Ñ—Ä—É—é—Ç –∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç."
        ),
        "vraag": "–ö–∞–∫–æ–µ —Å–ª–æ–≤–æ –ª—É—á—à–µ –≤—Å–µ–≥–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–∞–∫–æ–π –Ω–∞–±–æ—Ä —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª?",
        "options": ["–Ω–∞–±–æ—Ä –ø—Ä–∞–≤–∏–ª", "—à–∫–∞—Ç—É–ª–∫–∞", "–±–ª–æ–∫ –¥–∞–Ω–Ω—ã—Ö", "–ø–æ–¥–ø–∏—Å—å"],
        "answer": "–Ω–∞–±–æ—Ä –ø—Ä–∞–≤–∏–ª",
        "why": "–ü—Ä–æ—Ç–æ–∫–æ–ª ‚Äî —ç—Ç–æ –∫–∞–∫ —Ä–∞–∑ –Ω–∞–±–æ—Ä –ø—Ä–∞–≤–∏–ª –¥–ª—è –æ–±–º–µ–Ω–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö.",
    },
]

PUZZLE_IMAGE = "tree_empty.png"
PUZZLE_IMAGE_FULL = "tree_full.jpg"

# =========================================================
# –ò–≥—Ä–∞ 2: –ü–∏—Å—å–º–æ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ (—Ä–µ–∂–∏–º words), —Å–¥–≤–∏–≥ ‚àí3
# =========================================================

LETTER_EXAMPLE_EXPLAIN = (
    "–®–∏—Ñ—Ä –¶–µ–∑–∞—Ä—è ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± –∑–∞–º–µ–Ω–∏—Ç—å –∫–∞–∂–¥—É—é –±—É–∫–≤—É –¥—Ä—É–≥–æ–π, —Å–¥–≤–∏–≥–∞—è –µ—ë –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–π "
    "–ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É. –ß–∏—Å–ª–æ –ø–æ–∑–∏—Ü–∏–π –Ω–∞–∑—ã–≤–∞—é—Ç –∫–ª—é—á–æ–º. –í –Ω–∞—à–µ–º –ø—Ä–∏–º–µ—Ä–µ –∫–ª—é—á —Ä–∞–≤–µ–Ω 3. "
    "–ü—Ä–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∫–µ –∫–∞–∂–¥–∞—è –±—É–∫–≤–∞ —Å–¥–≤–∏–≥–∞–µ—Ç—Å—è "
    "–Ω–∞ —Ç—Ä–∏ –ø–æ–∑–∏—Ü–∏–∏ –í–ü–ï–†–ï–î, –∞ –ø—Ä–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–µ ‚Äî –Ω–∞ —Ç—Ä–∏ –ø–æ–∑–∏—Ü–∏–∏ –ù–ê–ó–ê–î."
)

LETTER_PLAIN = (
    "–ü—É—Å—Ç—å –≤ –Ω–æ–≤–æ–º –≥–æ–¥—É —É —Ç–µ–±—è –±—É–¥–µ—Ç —Å—Ç–æ–ª—å–∫–æ —Ä–∞–¥–æ—Å—Ç–∏ —Å–∫–æ–ª—å–∫–æ —É –∫–æ—Ç–∞ –ª–µ–Ω–∏–≤—ã—Ö –¥–Ω–µ–π –Ω–∞ –¥–∏–≤–∞–Ω–µ"
)

LETTER_CIPHER = (
    "–¢–¶–§–•–Ø –ï –†–°–ï–°–ü –Å–°–ñ–¶ –¶ –•–ó–î–í –î–¶–ñ–ó–• –§–•–°–û–Ø–ù–° –£–ì–ñ–°–§–•–õ –§–ù–°–û–Ø–ù–° –¶ –ù–°–•–ì –û–ó–†–õ–ï–Æ–® –ñ–†–ó–ú –†–ì –ñ–õ–ï–ì–†–ó"
)

# =========================================================
# –ë–∞–∑–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
# =========================================================

@app.route("/")
def index():
    return render_template("index.html")


@app.route("/start", methods=["GET", "POST"])
def start():
    if request.method == "POST":
        nick = request.form.get("nick", "").strip()
        if not nick:
            flash("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —Å–≤–æ–π –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π –Ω–∏–∫ üéÑ", "danger")
            return redirect(url_for("start"))
        session.clear()
        session["nick"] = nick
        session["mode"] = None
        return redirect(url_for("game"))
    return render_template("start.html")


@app.route("/game")
def game():
    if "nick" not in session:
        return redirect(url_for("start"))

    if session.get("mode") is None:
        return render_template("game_menu.html", nick=session["nick"])

    mode = session["mode"]

    if mode == "quiz":
        return render_quiz()

    if mode == "words":
        return render_letter_game()

    session["mode"] = None
    return redirect(url_for("game"))


@app.route("/choose_mode/<mode>")
def choose_mode(mode):
    if "nick" not in session:
        return redirect(url_for("start"))

    if mode == "quiz":
        session["mode"] = "quiz"
        tasks = QUIZ_TASKS.copy()
        random.shuffle(tasks)
        session["quiz_tasks"] = tasks
        session["current"] = 0
        session["score"] = 0
    elif mode == "words":
        session["mode"] = "words"
        session["letter_step"] = 0
    else:
        flash("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º –∏–≥—Ä—ã, –∫–æ—Ç —Ä–∞—Å—Ç–µ—Ä—è–ª—Å—è üêæ", "danger")
        session["mode"] = None

    return redirect(url_for("game"))

# =========================================================
# –ò–≥—Ä–∞ 1: –ª–æ–≥–∏–∫–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –ø—Ä–æ —ë–ª–∫—É
# =========================================================

def render_quiz():
    if "quiz_tasks" not in session:
        flash("–°–Ω–µ–∂–Ω–∞—è —Å–µ—Å—Å–∏—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å. –í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º –∑–∞–Ω–æ–≤–æ ‚ùÑÔ∏è", "warning")
        session["mode"] = None
        return redirect(url_for("game"))

    current = session.get("current", 0)
    tasks = session["quiz_tasks"]

    if current >= len(tasks):
        score = session.get("score", 0)
        total = len(tasks)
        full_tree = score >= 8

        if full_tree:
            flash(
                f"–ú—è—É! –¢—ã –Ω–∞—Ä—è–¥–∏–ª(–∞) –∫—Ä–∏–ø—Ç–æ‚Äë—ë–ª–∫—É –ø–æ—á—Ç–∏ –¥–æ —Å–∞–º–æ–π –∑–≤–µ–∑–¥—ã: {score} –∏–∑ {total} –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤. "
                "–í—Å–µ –æ–≥–æ–Ω—å–∫–∏ –≥–æ—Ä—è—Ç, –º–æ–∂–Ω–æ –∏–¥—Ç–∏ –∑–∞ —Å–ª–∞–¥–∫–∏–º –ø—Ä–∏–∑–æ–º! üéÑ",
                "success",
            )
        else:
            flash(
                f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {score} –∏–∑ {total}. –ß–∞—Å—Ç—å –∏–≥—Ä—É—à–µ–∫ –µ—â—ë –Ω–µ –∑–∞–∂–≥–ª–∞—Å—å, "
                "–Ω–æ –∫—Ä–∏–ø—Ç–æ‚Äë–∫–æ—Ç –≤–µ—Ä–∏—Ç, —á—Ç–æ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ —ë–ª–∫–∞ –±—É–¥–µ—Ç —Å–∏—è—Ç—å —è—Ä—á–µ! ‚ú®",
                "info",
            )
        return render_template(
            "quiz_game.html",
            nick=session["nick"],
            finished=True,
            score=score,
            total=total,
            full_tree=full_tree,
            image_full=PUZZLE_IMAGE_FULL,
            image_empty=PUZZLE_IMAGE,
        )

    task = tasks[current]
    progress = int((current / len(tasks)) * 100)
    return render_template(
        "quiz_game.html",
        nick=session["nick"],
        finished=False,
        task=task,
        task_num=current + 1,
        total_tasks=len(tasks),
        progress=progress,
        image_empty=PUZZLE_IMAGE,
    )


@app.route("/submit_quiz", methods=["POST"])
def submit_quiz():
    if "nick" not in session or session.get("mode") != "quiz":
        return redirect(url_for("start"))

    answer = request.form.get("answer", "").lower().strip()
    current = session.get("current", 0)
    tasks = session["quiz_tasks"]

    if current >= len(tasks):
        return redirect(url_for("game"))

    task = tasks[current]
    correct = task["answer"].lower()

    if answer == correct:
        session["score"] = session.get("score", 0) + 1
        flash(f"–í–µ—Ä–Ω–æ! {task['why']}", "success")
    else:
        flash(
            f"–ù–µ–º–Ω–æ–≥–æ –º–∏–º–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: ¬´{task['answer']}¬ª. {task['why']}",
            "danger",
        )

    session["current"] = current + 1
    return redirect(url_for("game"))

# =========================================================
# –ò–≥—Ä–∞ 2: –ª–æ–≥–∏–∫–∞ –ø–∏—Å—å–º–∞ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ (—Å–¥–≤–∏–≥ ‚àí3)
# =========================================================

def render_letter_game():
    step = session.get("letter_step", 0)

    if step == 0:
        return render_template(
            "words_game.html",
            nick=session["nick"],
            step=0,
            example_explain=LETTER_EXAMPLE_EXPLAIN,
            cipher=None,
            finished=False,
        )
    elif step == 1:
        return render_template(
            "words_game.html",
            nick=session["nick"],
            step=1,
            example_explain=LETTER_EXAMPLE_EXPLAIN,
            cipher=LETTER_CIPHER,
            finished=False,
        )
    else:
        return render_template(
            "words_game.html",
            nick=session["nick"],
            step=2,
            example_explain=LETTER_EXAMPLE_EXPLAIN,
            cipher=LETTER_CIPHER,
            plain=LETTER_PLAIN,
            finished=True,
        )


@app.route("/submit_word", methods=["POST"])
def submit_word():
    if "nick" not in session or session.get("mode") != "words":
        return redirect(url_for("start"))

    step = session.get("letter_step", 0)

    if step == 0:
        session["letter_step"] = 1
        return redirect(url_for("game"))

    if step == 1:
        user_text = request.form.get("phrase", "")
        # –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º: —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
        user_clean = " ".join(user_text.strip().split()).lower()
        correct_clean = " ".join(LETTER_PLAIN.strip().split()).lower()

        if not user_clean:
            flash("–ü–æ–ø—Ä–æ–±—É–π –≤–≤–µ—Å—Ç–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—É—é –Ω–æ–≤–æ–≥–æ–¥–Ω—é—é —Ñ—Ä–∞–∑—É ‚ùÑÔ∏è", "warning")
            return redirect(url_for("game"))

        if user_clean == correct_clean:
            flash("–ú—è—É! –ü–∏—Å—å–º–æ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ! üéÖ", "success")
            session["letter_step"] = 2
        else:
            flash(
                "–ü–æ—Ö–æ–∂–µ, —Ñ—Ä–∞–∑–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π. "
                "–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –¥–≤–∏–≥–∞–µ—à—å –∫–∞–∂–¥—É—é –±—É–∫–≤—É –Ω–∞ —Ç—Ä–∏ –ø–æ–∑–∏—Ü–∏–∏ –≤–ø–µ—Ä—ë–¥ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.",
                "danger",
            )
        return redirect(url_for("game"))

    return redirect(url_for("game"))

# =========================================================
# –°–±—Ä–æ—Å
# =========================================================

@app.route("/reset")
def reset():
    session.clear()
    flash("–°–Ω–µ–∂–Ω—ã–π —Ç–∞–π–º–µ—Ä –æ–±–Ω—É–ª–∏–ª—Å—è. –í–≤–µ–¥–∏ –Ω–æ–≤—ã–π –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π –Ω–∏–∫ –∏ –Ω–∞—á–Ω—ë–º —Å–Ω–∞—á–∞–ª–∞ üéÑ", "info")
    return redirect(url_for("start"))


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)

